# day11-完善线程池，加入一个简单的测试程序

在昨天的教程里，我们添加了一个最简单的线程池到服务器，一个完整的Reactor模式正式成型。这个线程池只是为了满足我们的需要构建出的最简单的线程池，存在很多问题。比如，由于任务队列的添加、取出都存在拷贝操作，线程池不会有太好的性能，只能用来学习，正确做法是使用右值移动、完美转发等阻止拷贝。另外线程池只能接受`std::function<void()>`类型的参数，所以函数参数需要事先使用`std::bind()`，并且无法得到返回值。

今天主要的工作是完善这个线程池，写一个简单的多线程高并发测试程序，支持vscode调试，并且分析为什么我们不能使用这种多线程架构。注意Makefile文件也已重写，现在使用make只能编译服务器，客户端、测试程序的编译指令请参考Makefile文件。

修复了以下bug
1. Acceptor应该使用LT模式，建立好连接后处理事件fd读写用ET模式
2. Acceptor建立连接不应该使用线程池，建立好连接后处理事件用线程池
3. 线程池add函数不能放在cpp文件中，因为C++编译器不支持模版分离编译（这是一个复杂的问题，具体细节请参考《深入理解计算机系统》有关编译、链接的章节）

使用线程池，并发太高可能出现Segmentation fault或Bad file description等众多错误。因为当前模式缺点很多，需要改用one loop per thread模式重写，

写了多线程高并发测试程序，具体使用方法：

./test -t 10000 -m 10 (-w 100)

10000个线程，每个线程回显10次，建立连接后等待100秒开始发送消息（可用于测试服务器能同时保持的最大连接数）。不指定w参数，则建立连接后开始马上发送消息。

gdb server

r

where / bt